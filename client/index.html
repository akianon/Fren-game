<canvas id="ctx" width="500" height="500" style="z-index:1;left:1px;border:1px solid #000000;position:absolute;"></canvas>
<canvas id="background" width="500" height="500" style="left:1px;border:1px solid #000000;position:absolute;"></canvas>

<div id="chat-text" style="position:absolute;top:600px;width:500px;height:100px;overflow-y:scroll;">

</div>
<form id="chat-form">
<input id="chat-input" type=text" style="position:absolute;top:700px;width:500px"></input>
</form>
<script src="client/res/ClientPlayer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
<script>
var socket = io();
var chatFocused = false;
var world = [];
var player={};
var PLAYER_LIST = {};

var chatText = document.getElementById('chat-text');
var chatInput = document.getElementById('chat-input');
var chatForm = document.getElementById('chat-form');
var ctx = document.getElementById("ctx").getContext("2d");
var bg = document.getElementById("background").getContext("2d");

chatInput.addEventListener("focus", function(){chatFocused = true}, true);
chatInput.addEventListener("blur", function(){chatFocused = false}, true);

var tilesetImage = new Image();
var femaleSpriteSheet = new Image();

var loaded = false;

ctx.font = '30px Arial';
tilesetImage.src = 'client/tilesheet.png';
femaleSpriteSheet.src = 'client/avatars/Base-Female.png';
tilesetImage.onload = requestWorld();
//requestWorld(1);


function requestWorld(w){
	socket.emit('requestWorld',w);
}//requestWorld(w){

function loop(){
	setInterval(function(){

	},1000/25);
}

function drawGround(){

var tileSize = 32;       // The size of a tile (32Ã—32)
var rowTileCount = 20;   // The number of tiles in a row of our background
var colTileCount = 20;   // The number of tiles in a column of our background
var imageNumTiles = 10;  // The number of tiles per row in the tileset image


  for (var r = 0; r < rowTileCount; r++) {
      for (var c = 0; c < colTileCount; c++) {
     // console.log(r);
         var tile = world[r][c];
         var tileRow = (tile / imageNumTiles) | 0; // Bitwise OR operation
         var tileCol = (tile % imageNumTiles) | 0;
         bg.drawImage(tilesetImage, (tileCol * tileSize), (tileRow * tileSize), tileSize, tileSize, (c * tileSize), (r * tileSize), tileSize, tileSize);
      }
   }
}

socket.on("newPositions",function(data){
//console.log(data);   
	for(i in data){	
		var player = new ClientPlayer(i);
		PLAYER_LIST[i.id] = i;
		player.draw(ctx,femaleSpriteSheet);
	}//for(i in data){
});
    
 
    
    
    socket.on("addToChat",function(data){
        chatText.innerHTML += '<div>' + data + '</div>';
        chatText.scrollTop = chatText.scrollHeight;
    });
     socket.on("evalAnswer",function(data){
        console.log(data);
    });
    socket.on("worldUpdate",function(data){
    loaded = true;
      world = data;
      console.log(data);
      drawGround();
    });
    
    chatForm.onsubmit = function(e){
    e.preventDefault();
    if(chatInput.value[0]==='/'){
        socket.emit('evalServer',chatInput.value.slice(1));
        }else{
    socket.emit('sendMsgToServer',chatInput.value);
    chatInput.value = '';
    }
        chatInput.blur();

    }
    document.onkeydown = function(event){
    if(!chatFocused){
        if(event.keyCode==68)
            socket.emit('keyPress',{inputId:'right',state:true});
        else if(event.keyCode==83)
            socket.emit('keyPress',{inputId:'down',state:true});
        else if(event.keyCode==65)
            socket.emit('keyPress',{inputId:'left',state:true});
        else if(event.keyCode==87)
            socket.emit('keyPress',{inputId:'up',state:true});
               
        }
        }
    document.onkeyup = function(event){
        if(!chatFocused){
        if(event.keyCode==68)
            socket.emit('keyPress',{inputId:'right',state:false});
        else if(event.keyCode==83)
            socket.emit('keyPress',{inputId:'down',state:false});
        else if(event.keyCode==65)
            socket.emit('keyPress',{inputId:'left',state:false});
        else if(event.keyCode==87)
            socket.emit('keyPress',{inputId:'up',state:false});
              } 
        }
loop();

</script>